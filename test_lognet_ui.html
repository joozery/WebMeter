<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test LogNet UI Display</title>
    <style>
        .tree-node {
            margin: 5px 0;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .location-node {
            background-color: #e3f2fd;
        }
        .lognet-node {
            background-color: #f3e5f5;
            margin-left: 20px;
        }
        .sub-location-node {
            background-color: #e8f5e8;
            margin-left: 20px;
        }
        .icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 5px;
            text-align: center;
        }
        .location-icon { background-color: #2196f3; color: white; }
        .folder-icon { background-color: #ff9800; color: white; }
        .lognet-icon { background-color: #9c27b0; color: white; }
    </style>
</head>
<body>
    <h1>Test LogNet UI Display</h1>
    
    <h2>API Endpoints Test:</h2>
    <button onclick="loadAndDisplayTree()">Load and Display Tree</button>
    <button onclick="createTestData()">Create Test Data</button>
    <button onclick="clearResults()">Clear Results</button>
    
    <h3>Tree Structure:</h3>
    <div id="tree-display" style="background: #f9f9f9; padding: 10px; margin: 10px 0; border: 1px solid #ddd;"></div>
    
    <h3>Raw Data:</h3>
    <div id="results" style="background: #f5f5f5; padding: 10px; margin: 10px 0; white-space: pre-wrap; font-family: monospace;"></div>
    
    <script>
        const API_BASE = '/api/meter-tree';
        
        async function loadAndDisplayTree() {
            try {
                // à¹‚à¸«à¸¥à¸” locations à¹à¸¥à¸° lognets
                const [locationsResponse, lognetsResponse] = await Promise.all([
                    fetch(`${API_BASE}/locations`),
                    fetch(`${API_BASE}/lognets`)
                ]);
                
                const locations = await locationsResponse.json();
                const lognets = await lognetsResponse.json();
                
                console.log('Locations:', locations);
                console.log('LogNets:', lognets);
                
                // à¸ªà¸£à¹‰à¸²à¸‡ tree structure
                const tree = buildTree(locations, lognets);
                
                // à¹à¸ªà¸”à¸‡ tree à¹ƒà¸™ UI
                displayTree(tree);
                
                // à¹à¸ªà¸”à¸‡ raw data
                document.getElementById('results').textContent = 
                    'Locations:\n' + JSON.stringify(locations, null, 2) + 
                    '\n\nLogNets:\n' + JSON.stringify(lognets, null, 2) +
                    '\n\nTree Structure:\n' + JSON.stringify(tree, null, 2);
                
            } catch (error) {
                document.getElementById('results').textContent = 'Error: ' + error.message;
            }
        }
        
        function buildTree(locations, lognets, parentId = null) {
            return locations
                .filter(location => location.parent_id === parentId)
                .map(location => {
                    // à¸«à¸² lognets à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ location à¸™à¸µà¹‰
                    const locationLogNets = lognets.filter(lognet => {
                        // LogNets à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ Main Location (à¹„à¸¡à¹ˆà¸¡à¸µ sublocation_id)
                        if (lognet.location_id === location.id && 
                            (lognet.sublocation_id === null || lognet.sublocation_id === undefined)) {
                            return true;
                        }
                        // LogNets à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ Sub Location (à¸¡à¸µ sublocation_id à¸•à¸£à¸‡à¸à¸±à¸š location.id)
                        if (lognet.sublocation_id === location.id) {
                            return true;
                        }
                        return false;
                    });
                    
                    // à¸«à¸² sub-locations
                    const subLocations = buildTree(locations, lognets, location.id);
                    
                    // à¸£à¸§à¸¡ lognets à¹à¸¥à¸° sub-locations à¹€à¸›à¹‡à¸™ children
                    const children = [
                        ...subLocations,
                        ...locationLogNets.map(lognet => ({
                            id: `lognet-${lognet.id}`,
                            name: lognet.name,
                            iconType: 'lognet',
                            brand: lognet.brand,
                            model: lognet.model,
                            serialNumber: lognet.serial_number,
                            firmwareVersion: lognet.firmware_version,
                            ip: lognet.ip_address,
                            subnetMask: lognet.subnet_mask,
                            gateway: lognet.gateway,
                            dns: lognet.dns,
                            children: []
                        }))
                    ];
                    
                    return {
                        id: `location-${location.id}`,
                        name: location.name,
                        parent_id: location.parent_id,
                        iconType: location.parent_id === null ? 'location' : 'folder',
                        children: children
                    };
                });
        }
        
        function displayTree(nodes, level = 0) {
            const container = document.getElementById('tree-display');
            container.innerHTML = '';
            
            function renderNode(node, level) {
                const nodeDiv = document.createElement('div');
                nodeDiv.className = 'tree-node';
                
                let iconClass = '';
                let nodeClass = '';
                
                if (node.iconType === 'location') {
                    iconClass = 'location-icon';
                    nodeClass = 'location-node';
                } else if (node.iconType === 'folder') {
                    iconClass = 'folder-icon';
                    nodeClass = 'sub-location-node';
                } else if (node.iconType === 'lognet') {
                    iconClass = 'lognet-icon';
                    nodeClass = 'lognet-node';
                }
                
                nodeDiv.className = `tree-node ${nodeClass}`;
                nodeDiv.style.marginLeft = `${level * 20}px`;
                
                const icon = document.createElement('span');
                icon.className = `icon ${iconClass}`;
                icon.textContent = node.iconType === 'location' ? 'ðŸ¢' : 
                                 node.iconType === 'folder' ? 'ðŸ“' : 
                                 node.iconType === 'lognet' ? 'ðŸ–¥ï¸' : '?';
                
                const name = document.createElement('span');
                name.textContent = node.name || '(unnamed)';
                
                nodeDiv.appendChild(icon);
                nodeDiv.appendChild(name);
                
                // à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡à¸ªà¸³à¸«à¸£à¸±à¸š LogNet
                if (node.iconType === 'lognet') {
                    const details = document.createElement('div');
                    details.style.fontSize = '12px';
                    details.style.color = '#666';
                    details.style.marginLeft = '25px';
                    details.innerHTML = `
                        Brand: ${node.brand || '-'} | 
                        Model: ${node.model || '-'} | 
                        Serial: ${node.serialNumber || '-'}
                    `;
                    nodeDiv.appendChild(details);
                }
                
                container.appendChild(nodeDiv);
                
                // à¹à¸ªà¸”à¸‡ children
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => renderNode(child, level + 1));
                }
            }
            
            nodes.forEach(node => renderNode(node, level));
        }
        
        async function createTestData() {
            try {
                // à¸ªà¸£à¹‰à¸²à¸‡ Main Location
                const mainLocationResponse = await fetch(`${API_BASE}/locations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'Test Main Location',
                        description: 'Test main location',
                        parent_id: null
                    })
                });
                const mainLocation = await mainLocationResponse.json();
                
                // à¸ªà¸£à¹‰à¸²à¸‡ Sub Location
                const subLocationResponse = await fetch(`${API_BASE}/locations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'Test Sub Location',
                        description: 'Test sub location',
                        parent_id: mainLocation.id
                    })
                });
                const subLocation = await subLocationResponse.json();
                
                // à¸ªà¸£à¹‰à¸²à¸‡ LogNet à¹ƒà¸™ Main Location
                const lognetMainResponse = await fetch(`${API_BASE}/lognets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location_id: mainLocation.id,
                        sublocation_id: null,
                        name: 'LogNet in Main Location',
                        model: 'Test Model',
                        brand: 'Test Brand',
                        serial_number: 'SN001',
                        firmware_version: 'v1.0',
                        ip_address: null,
                        subnet_mask: null,
                        gateway: null,
                        dns: null,
                        is_active: true
                    })
                });
                const lognetMain = await lognetMainResponse.json();
                
                // à¸ªà¸£à¹‰à¸²à¸‡ LogNet à¹ƒà¸™ Sub Location
                const lognetSubResponse = await fetch(`${API_BASE}/lognets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location_id: mainLocation.id,
                        sublocation_id: subLocation.id,
                        name: 'LogNet in Sub Location',
                        model: 'Test Model',
                        brand: 'Test Brand',
                        serial_number: 'SN002',
                        firmware_version: 'v1.0',
                        ip_address: null,
                        subnet_mask: null,
                        gateway: null,
                        dns: null,
                        is_active: true
                    })
                });
                const lognetSub = await lognetSubResponse.json();
                
                document.getElementById('results').textContent = 
                    'Test data created successfully!\n\n' +
                    'Main Location: ' + JSON.stringify(mainLocation, null, 2) + '\n\n' +
                    'Sub Location: ' + JSON.stringify(subLocation, null, 2) + '\n\n' +
                    'LogNet in Main: ' + JSON.stringify(lognetMain, null, 2) + '\n\n' +
                    'LogNet in Sub: ' + JSON.stringify(lognetSub, null, 2);
                
                // à¹‚à¸«à¸¥à¸”à¹à¸¥à¸°à¹à¸ªà¸”à¸‡ tree à¹ƒà¸«à¸¡à¹ˆ
                setTimeout(() => loadAndDisplayTree(), 1000);
                
            } catch (error) {
                document.getElementById('results').textContent = 'Error: ' + error.message;
            }
        }
        
        function clearResults() {
            document.getElementById('results').textContent = '';
            document.getElementById('tree-display').innerHTML = '';
        }
    </script>
</body>
</html>
